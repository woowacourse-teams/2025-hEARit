<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>히어릿 관리</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .pagination {
            margin-top: 20px;
        }
        .pagination button {
            padding: 8px 16px;
        }
        #upload-section { display: none; margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        #upload-form div { margin-bottom: 10px; }
    </style>
</head>
<body>
<h1>히어릿 관리</h1>

<button id="toggle-upload-form">히어릿 추가</button>

<div id="upload-section">
    <h2>새 히어릿 업로드</h2>
    <form id="upload-form">
        <div>
            <label for="title">제목</label>
            <input type="text" id="title" name="title">
        </div>
        <div>
            <label for="summary">요약</label>
            <input type="text" id="summary" name="summary">
        </div>
        <div>
            <label for="playTime">재생 시간(초)</label>
            <input type="number" id="playTime" name="playTime">
        </div>
        <div>
            <label for="originalAudioUrl">원본 오디오 URL</label>
            <input type="text" id="originalAudioUrl" name="originalAudioUrl">
        </div>
        <div>
            <label for="shortAudioUrl">요약 오디오 URL</label>
            <input type="text" id="shortAudioUrl" name="shortAudioUrl">
        </div>
        <div>
            <label for="scriptUrl">대본 URL</label>
            <input type="text" id="scriptUrl" name="scriptUrl">
        </div>
        <div>
            <label for="source">출처</label>
            <input type="text" id="source" name="source">
        </div>
        <div>
            <label for="categoryId">카테고리</label>
            <select id="categoryId" name="categoryId" required>
                <option value="" disabled selected>카테고리를 선택하세요</option>
            </select>
        </div>
        <div>
            <label>키워드</label>
            <div id="keyword-checkboxes">
                <!-- 키워드 체크박스가 여기에 동적으로 추가됩니다. -->
            </div>
        </div>
        <button type="button" onclick="uploadHearit()">등록</button>
    </form>
</div>

<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>제목</th>
        <th>요약</th>
        <th>재생 시간</th>
        <th>출처</th>
        <th>생성일</th>
        <th>작업</th>
    </tr>
    </thead>
    <tbody id="hearit-table-body">
    <!-- 히어릿 데이터가 여기에 동적으로 추가됩니다. -->
    </tbody>
</table>

<div class="pagination">
    <button id="prev-page" disabled>이전</button>
    <span id="page-info"></span>
    <button id="next-page" disabled>다음</button>
</div>

<script>
    let currentPage = 0;
    const pageSize = 15;

    // --- 데이터 로드 함수들 ---
    async function fetchCategories() {
        try {
            const response = await fetch('/api/v1/admin/categories');
            if (response.ok) {
                const categories = await response.json();
                const categorySelect = document.getElementById('categoryId');
                categorySelect.innerHTML = '<option value="" disabled selected>카테고리를 선택하세요</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            } else {
                console.error('카테고리를 불러오는 데 실패했습니다.');
            }
        } catch (error) {
            console.error('Error fetching categories:', error);
        }
    }

    async function fetchKeywords() {
        try {
            const response = await fetch('/api/v1/admin/keywords');
            if (response.ok) {
                const keywords = await response.json();
                const keywordCheckboxes = document.getElementById('keyword-checkboxes');
                keywordCheckboxes.innerHTML = '';
                keywords.forEach(keyword => {
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'keywordIds';
                    checkbox.value = keyword.id;
                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(keyword.name));
                    keywordCheckboxes.appendChild(label);
                });
            } else {
                console.error('키워드를 불러오는 데 실패했습니다.');
            }
        } catch (error) {
            console.error('Error fetching keywords:', error);
        }
    }

    async function fetchHearits(page) {
        try {
            const response = await fetch(`/api/v1/admin/hearits?page=${page}&size=${pageSize}`);
            if (!response.ok) throw new Error('데이터를 불러오는 데 실패했습니다.');
            const pagedData = await response.json();
            updateTable(pagedData.content);
            updatePagination(pagedData);
            currentPage = page;
        } catch (error) {
            console.error('Error fetching hearits:', error);
            alert(error.message);
        }
    }

    // --- UI 업데이트 함수들 ---
    function updateTable(hearits) {
        const tableBody = document.getElementById('hearit-table-body');
        tableBody.innerHTML = '';
        hearits.forEach(hearit => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${hearit.id}</td>
                <td>${hearit.title}</td>
                <td>${hearit.summary}</td>
                <td>${hearit.playTime}초</td>
                <td>${hearit.source}</td>
                <td>${new Date(hearit.createdAt).toLocaleString()}</td>
                <td><button onclick="deleteHearit(${hearit.id})">삭제</button></td>
            `;
            tableBody.appendChild(row);
        });
    }

    function updatePagination(pagedData) {
        document.getElementById('page-info').textContent = `페이지 ${pagedData.page + 1} / ${pagedData.totalPages}`;
        document.getElementById('prev-page').disabled = pagedData.isFirst;
        document.getElementById('next-page').disabled = pagedData.isLast;
    }
    
    // --- 이벤트 핸들러 함수들 ---
    async function uploadHearit() {
        const form = document.getElementById('upload-form');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        data.keywordIds = formData.getAll('keywordIds').map(id => parseInt(id, 10));

        if (!data.categoryId) {
            alert('카테고리를 선택해주세요.');
            return;
        }

        data.playTime = parseInt(data.playTime, 10);
        data.categoryId = parseInt(data.categoryId, 10);

        try {
            const response = await fetch('/api/v1/admin/hearits', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                alert('히어릿이 성공적으로 업로드되었습니다.');
                form.reset();
                document.getElementById('upload-section').style.display = 'none';
                fetchHearits(0);
            } else {
                const errorData = await response.json();
                alert('업로드 실패: ' + (errorData.message || '서버 오류'));
            }
        } catch (error) {
            console.error('Error uploading hearit:', error);
            alert('업로드 중 오류가 발생했습니다.');
        }
    }

    async function deleteHearit(hearitId) {
        if (!confirm(`정말로 ID ${hearitId} 히어릿을 삭제하시겠습니까?`)) return;
        try {
            const response = await fetch(`/api/v1/admin/hearits/${hearitId}`, { method: 'DELETE' });
            if (response.ok) {
                alert('성공적으로 삭제되었습니다.');
                fetchHearits(currentPage);
            } else {
                throw new Error('삭제에 실패했습니다.');
            }
        } catch (error) {
            console.error('Error deleting hearit:', error);
            alert(error.message);
        }
    }

    // --- 페이지 초기화 ---
    document.addEventListener('DOMContentLoaded', () => {
        // 데이터 로드
        fetchCategories();
        fetchKeywords();
        fetchHearits(0);

        // 이벤트 리스너 등록
        document.getElementById('toggle-upload-form').addEventListener('click', () => {
            const formSection = document.getElementById('upload-section');
            const isHidden = formSection.style.display === 'none';
            formSection.style.display = isHidden ? 'block' : 'none';
        });
        
        document.getElementById('prev-page').addEventListener('click', () => {
            fetchHearits(currentPage - 1);
        });

        document.getElementById('next-page').addEventListener('click', () => {
            fetchHearits(currentPage + 1);
        });
    });
</script>

</body>
</html> 