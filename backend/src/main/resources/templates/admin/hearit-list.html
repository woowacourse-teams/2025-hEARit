<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>히어릿 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        #upload-section { display: none; }
        #keyword-section { display: none; }
    </style>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
<div th:insert="~{admin/navbar :: navbar}"></div>
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1>히어릿 관리</h1>
    </div>
    <div>
        <p id="hearit-count" class="text-muted mb-0">히어릿 총 개수: 0개</p>
    </div>

    <!-- 히어릿 목록 테이블 및 페이징 -->
    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th scope="col">ID</th>
                <th scope="col">Title</th>
                <th scope="col">Summary</th>
                <th scope="col">Play Time</th>
                <th scope="col">Original Audio URL</th>
                <th scope="col">Short Audio URL</th>
                <th scope="col">Script URL</th>
                <th scope="col">Source</th>
                <th scope="col">Created At</th>
                <th scope="col">Category</th>
                <th scope="col">Keywords</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody id="hearit-table-body"></tbody>
    </table>
    <nav><ul class="pagination justify-content-center" id="pagination-controls"></ul></nav>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let currentPage = 0;
    const pageSize = 15;

    async function fetchHearits(page) {
        try {
            const response = await fetch(`/api/v1/admin/hearits?page=${page}&size=${pageSize}`);
            if (!response.ok) throw new Error('데이터를 불러오는 데 실패했습니다.');
            const pagedData = await response.json();
            updateTable(pagedData.content);
            updatePagination(pagedData);
            document.getElementById('hearit-count').textContent = `히어릿 총 개수: ${pagedData.totalElements}개`;
            currentPage = page;
        } catch (error) {
            console.error('Error fetching hearits:', error);
            alert(error.message);
        }
    }

    // Renders the hearit list table
    let editingId = null;
    function updateTable(hearits) {
        const tableBody = document.getElementById('hearit-table-body');
        tableBody.innerHTML = '';
        hearits.forEach(hearit => {
            const row = document.createElement('tr');
            if (editingId === hearit.id) {
                // Edit mode: show inputs for editable fields, others as text
                row.innerHTML = `
                    <td>${hearit.id}</td>
                    <td><input type="text" class="form-control" value="${hearit.title}" id="edit-title-${hearit.id}" style="min-width: 120px;"></td>
                    <td><input type="text" class="form-control" value="${hearit.summary || ''}" id="edit-summary-${hearit.id}" style="min-width: 120px;"></td>
                    <td style="min-width: 80px;"><input type="number" class="form-control" value="${hearit.playTime}" id="edit-playtime-${hearit.id}" style="min-width: 120px;"></td>
                    <td><input type="text" class="form-control" value="${hearit.originalAudioUrl || ''}" id="edit-original-url-${hearit.id}" style="min-width: 120px;"></td>
                    <td><input type="text" class="form-control" value="${hearit.shortAudioUrl || ''}" id="edit-short-url-${hearit.id}" style="min-width: 120px;"></td>
                    <td><input type="text" class="form-control" value="${hearit.scriptUrl || ''}" id="edit-script-url-${hearit.id}" style="min-width: 120px;"></td>
                    <td><input type="text" class="form-control" value="${hearit.source}" id="edit-source-${hearit.id}" style="min-width: 120px;"></td>
                    <td>${hearit.createdAt ? new Date(hearit.createdAt).toLocaleString() : ''}</td>
                    <td>
                        ${hearit.category?.name || ''}
                        <input type="hidden" id="edit-category-id-${hearit.id}" value="${hearit.category?.id || ''}">
                    </td>
                    <td>${
                        Array.isArray(hearit.keywords)
                            ? hearit.keywords.map(k => `<span class="badge text-bg-secondary me-1">${k.name}</span>`).join('')
                            : ''
                    }</td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="saveEdit(${hearit.id})">저장</button>
                        <button class="btn btn-secondary btn-sm" onclick="cancelEditHearit()">취소</button>
                    </td>
                `;
            } else {
                // Display mode
                row.innerHTML = `
                    <td>${hearit.id}</td>
                    <td>${hearit.title}</td>
                    <td>${hearit.summary}</td>
                    <td style="min-width: 80px;">${hearit.playTime}초</td>
                    <td>${hearit.originalAudioUrl ? hearit.originalAudioUrl : ''}</td>
                    <td>${hearit.shortAudioUrl ? hearit.shortAudioUrl : ''}</td>
                    <td>${hearit.scriptUrl ? hearit.scriptUrl : ''}</td>
                    <td>${hearit.source}</td>
                    <td>${hearit.createdAt ? new Date(hearit.createdAt).toLocaleString() : ''}</td>
                    <td>${hearit.category?.name || ''}</td>
                    <td>${
                        Array.isArray(hearit.keywords)
                            ? hearit.keywords.map(k => `<span class="badge text-bg-secondary me-1">${k.name}</span>`).join('')
                            : ''
                    }</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editHearit(${hearit.id})">수정</button>
                    </td>
                `;
            }
            tableBody.appendChild(row);
        });
    }

    function updatePagination(pagedData) {
        const paginationControls = document.getElementById('pagination-controls');
        paginationControls.innerHTML = '';
        const createPageItem = (text, page, isDisabled = false, isActive = false) => {
            const li = document.createElement('li');
            li.className = `page-item ${isDisabled ? 'disabled' : ''} ${isActive ? 'active' : ''}`;
            const link = document.createElement('a');
            link.className = 'page-link';
            link.href = '#';
            link.textContent = text;
            if (!isDisabled) {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    fetchHearits(page);
                });
            }
            li.appendChild(link);
            return li;
        };
        paginationControls.appendChild(createPageItem('이전', currentPage - 1, pagedData.isFirst));
        paginationControls.appendChild(createPageItem(`${pagedData.page + 1} / ${pagedData.totalPages}`, -1, true));
        paginationControls.appendChild(createPageItem('다음', currentPage + 1, pagedData.isLast));
    }


    // Start editing a hearit
    function editHearit(hearitId) {
        editingId = hearitId;
        fetchHearits(currentPage);
    }

    // Save edits for a hearit
    async function saveEdit(id) {
        const title = document.getElementById(`edit-title-${id}`).value;
        const summary = document.getElementById(`edit-summary-${id}`).value;
        const playTime = parseInt(document.getElementById(`edit-playtime-${id}`).value, 10);
        const originalUrl = document.getElementById(`edit-original-url-${id}`).value;
        const shortUrl = document.getElementById(`edit-short-url-${id}`).value;
        const scriptUrl = document.getElementById(`edit-script-url-${id}`).value;
        const source = document.getElementById(`edit-source-${id}`).value;
        const categoryId = parseInt(document.getElementById(`edit-category-id-${id}`).value, 10);
        // categoryId, keywordIds 편집은 추후 지원
        const updated = {
            title,
            summary,
            playTime,
            originalAudioUrl: originalUrl,
            shortAudioUrl: shortUrl,
            scriptUrl: scriptUrl,
            source,
            categoryId
        };
        try {
            const csrfToken = document.querySelector('meta[name="_csrf"]').content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
            const response = await fetch(`/api/v1/admin/hearits/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify(updated)
            });
            if (response.ok) {
                alert('수정되었습니다.');
                editingId = null;
                fetchHearits(currentPage);
            } else {
                const err = await response.json();
                alert('수정 실패: ' + (err.message || '오류 발생'));
            }
        } catch (e) {
            console.error('Update error:', e);
            alert('수정 중 오류 발생');
        }
    }

    function cancelEditHearit() {
        editingId = null;
        fetchHearits(currentPage);
    }

    document.addEventListener('DOMContentLoaded', () => {
        fetchHearits(0);
    });
</script>
</body>
</html> 
